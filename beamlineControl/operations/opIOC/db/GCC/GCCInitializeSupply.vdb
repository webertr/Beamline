#! Generated by VisualDCT v2.6
#! DBDSTART
#! DBD("/users/hicksmj/epics/opsDisplay/db/bar.dbd")
#! DBDEND


# Sets Coil Init Failed status to 0
record(bo, "$(Group):Init:ResetInitFailed") {
  field(FLNK, "$(Group):Init:ACMD:Set")
  field(VAL, "0")
  field(OUT, "$(Group):InitFailed:Status.VAL PP")
}

# I don't know why this number is passed. Maybe it selects the "Selected Dev. Clear"
# command to send?
record(calcout, "$(Group):Init:ACMD:Set") {
  field(CALC, "3")
  field(OUT, "$(Group):Init:ACMD:DevClear.ACMD PP")
}

# Clears the powersupply GPIB communication in case it was corrupted,
# for example by bad syntax in a message.  Unlike the Agilents and
# Kepcos, we must force this to clear
record(asyn, "$(Group):Init:ACMD:DevClear") {
  field(DTYP, "asynRecordDevice")
  field(PORT, "$(AsynPort)")
  field(ADDR, "$(R)")
  field(OMAX, "4096")
  field(IMAX, "4096")
  field(SCAN, "Passive")
  field(AOUT, "ERR?")
  field(OEOS, "10")
  field(IEOS, "10")
  field(FLNK, "$(Group):Init:ACMD:Delay")
  field(TMOD, "Write/Read")
  field(TMOT, "1")
  field(ACMD, "Selected Dev. Clear (SDC)")
}

# Provides 3 sec delay for comm to clear before trying communications
record(seq, "$(Group):Init:ACMD:Delay") {
  field(SELM, "All")
  field(DLY1, "3")
  field(LNK1, "$(Group):Init:CheckError.PROC")
}

# Queries Kikisui ISM Supply for System Error information.  Since
# Kikusui Supplies do not report 240 - Hardware error, we will
# not set a flag depending on the contents of the error register,
# we will only flag if the error field of the asyn record
# (ERRS) indicates a comm problem.
record(asyn, "$(Group):Init:CheckError") {
  field(DTYP, "asynRecordDevice")
  field(PORT, "$(AsynPort)")
  field(ADDR, "$(R)")
  field(OMAX, "4096")
  field(IMAX, "4096")
  field(SCAN, "Passive")
  field(AOUT, "ERR?")
  field(OEOS, "10")
  field(IEOS, "10")
  field(FLNK, "$(Group):Init:CommErr:Reset")
  field(TMOD, "Write/Read")
  field(TMOT, "1")
}

# Reset Comm Error Status to False in GCCBeamInterlockCondition.vdb
record(bo, "$(Group):Init:CommErr:Reset") {
  field(VAL, "0")
  field(OUT, "$(Group):CommError:Status PP")
  field(FLNK, "$(Group)::Init:CommCheck")
}

# Checks for Comm error
# 
# Returns 2 for Comm Error
# 
# Returns 1 for No Comm Error
record(scalcout, "$(Group)::Init:CommCheck") {
  field(FLNK, "$(Group):Init:CommErrorCheck:Seq")
  field(CALC, "(AA!=0)+1")
  field(INAA, "$(Group):Init:CheckError.ERRS")
}

# LNK2 Aborts Init and Processes Logs Comm Error
# 
# LNK 1 continues Init Process
record(seq, "$(Group):Init:CommErrorCheck:Seq") {
  field(SELM, "Specified")
  field(SELL, "$(Group)::Init:CommCheck.VAL")
  field(LNK2, "$(Group):Curr:InitFailed2.PROC")
  field(LNK1, "$(Group):Init:PushCurrVal.PROC")
}

# At end of init, push curr val out to power supply.
# 
# $(Group):Curr:SetDevice.PROC PP is a record in GCCAnalog.vdb
# that will set the coil to whatever value is in Paramset.vdb.
record(seq, "$(Group):Init:PushCurrVal") {
  field(SELM, "All")
  field(LNK2, "$(Group):InitFinished.PROC")
  field(LNK1, "$(Group):Curr:SetDevice.PROC PP")
  field(DLY1, ".5")
  field(DLY2, ".5")
}

# Log Comm Error and continue to abort Init
record(stringout, "$(Group):Curr:InitFailed2") {
  field(FLNK, "$(Group):InitFailed:CommError")
  field(VAL, "$(Group) Com Err,Init Fail")
  field(OUT, "CCC:OpsDisplay:System:Write PP")
}

# Sets Coil Init Status to 1
record(bo, "$(Group):InitFailed:CommError") {
  field(FLNK, "$(Group):Init:CommError:True")
  field(VAL, "1")
  field(OUT, "$(Group):InitFailed:Status.VAL")
}

# Set Comm Error to True in GCCBeamInterlockCondition
# and continue to abort init
record(calcout, "$(Group):Init:CommError:True") {
  field(FLNK, "$(Group):InitFinished")
  field(VAL, "1")
  field(OUT, "$(Group):CommError:Status PP")
}

# Set Coil Init Status to zero
record(bo, "$(Group):InitFinished") {
  field(VAL, "0")
  field(OUT, "$(Group):Init:Status.VAL PP")
}

# Coil Init Status.  Used in GCCInitialize.vdb to determine when all coils
# have finished their individual portion of the init sequence.
record(bo, "$(Group):Init:Status") {
}

# Sets Coil init status to 1
# Begins sequence of initializing power supply.
# 
# This is processed from GCCInitialize. It is processed
# once.
record(bo, "$(Group):InitStarted") {
  field(FLNK, "$(Group):Init:ResetInitFailed")
  field(VAL, "1")
  field(OUT, "$(Group):Init:Status.VAL PP")
}

# Coil Init Failed Status:  Used to Abort Init Sequence in GCCInit.vdb
record(bo, "$(Group):InitFailed:Status") {
}

#! Further lines contain data used by VisualDCT
#! View(2838,2772,1.0)
#! Record("$(Group):Init:ResetInitFailed",160,2842,0,0,"$(Group):Init:ResetInitFailed")
#! Field("$(Group):Init:ResetInitFailed.FLNK",16777215,1,"$(Group):Init:ResetInitFailed.FLNK")
#! Link("$(Group):Init:ResetInitFailed.FLNK","$(Group):Init:ACMD:Set")
#! Field("$(Group):Init:ResetInitFailed.OUT",16777215,1,"$(Group):Init:ResetInitFailed.OUT")
#! Link("$(Group):Init:ResetInitFailed.OUT","$(Group):InitFailed:Status.VAL")
#! Record("$(Group):Init:ACMD:Set",540,2816,0,0,"$(Group):Init:ACMD:Set")
#! Field("$(Group):Init:ACMD:Set.OUT",16777215,1,"$(Group):Init:ACMD:Set.OUT")
#! Link("$(Group):Init:ACMD:Set.OUT","$(Group):Init:ACMD:DevClear.ACMD")
#! Record("$(Group):Init:ACMD:DevClear",900,2883,0,1,"$(Group):Init:ACMD:DevClear")
#! Field("$(Group):Init:ACMD:DevClear.FLNK",16777215,1,"$(Group):Init:ACMD:DevClear.FLNK")
#! Link("$(Group):Init:ACMD:DevClear.FLNK","$(Group):Init:ACMD:Delay")
#! Field("$(Group):Init:ACMD:DevClear.ACMD",16777215,0,"$(Group):Init:ACMD:DevClear.ACMD")
#! Record("$(Group):Init:ACMD:Delay",1160,2882,0,0,"$(Group):Init:ACMD:Delay")
#! Field("$(Group):Init:ACMD:Delay.LNK1",16777215,1,"$(Group):Init:ACMD:Delay.LNK1")
#! Link("$(Group):Init:ACMD:Delay.LNK1","$(Group):Init:CheckError.PROC")
#! Record("$(Group):Init:CheckError",1440,2917,0,0,"$(Group):Init:CheckError")
#! Field("$(Group):Init:CheckError.FLNK",16777215,1,"$(Group):Init:CheckError.FLNK")
#! Link("$(Group):Init:CheckError.FLNK","$(Group):Init:CommErr:Reset")
#! Field("$(Group):Init:CheckError.ERRS",16777215,1,"$(Group):Init:CheckError.ERRS")
#! Field("$(Group):Init:CheckError.PROC",16777215,0,"$(Group):Init:CheckError.PROC")
#! Record("$(Group):Init:CommErr:Reset",1720,3062,0,0,"$(Group):Init:CommErr:Reset")
#! Field("$(Group):Init:CommErr:Reset.OUT",16777215,1,"$(Group):Init:CommErr:Reset.OUT")
#! Field("$(Group):Init:CommErr:Reset.FLNK",16777215,1,"$(Group):Init:CommErr:Reset.FLNK")
#! Link("$(Group):Init:CommErr:Reset.FLNK","$(Group)::Init:CommCheck")
#! Record("$(Group)::Init:CommCheck",2460,3122,0,0,"$(Group)::Init:CommCheck")
#! Field("$(Group)::Init:CommCheck.FLNK",16777215,1,"$(Group)::Init:CommCheck.FLNK")
#! Link("$(Group)::Init:CommCheck.FLNK","$(Group):Init:CommErrorCheck:Seq")
#! Field("$(Group)::Init:CommCheck.INAA",16777215,0,"$(Group)::Init:CommCheck.INAA")
#! Link("$(Group)::Init:CommCheck.INAA","$(Group):Init:CheckError.ERRS")
#! Field("$(Group)::Init:CommCheck.VAL",16777215,1,"$(Group)::Init:CommCheck.VAL")
#! Visibility("$(Group)::Init:CommCheck.CALC",1)
#! Record("$(Group):Init:CommErrorCheck:Seq",2860,3108,0,0,"$(Group):Init:CommErrorCheck:Seq")
#! Field("$(Group):Init:CommErrorCheck:Seq.LNK1",16777215,1,"$(Group):Init:CommErrorCheck:Seq.LNK1")
#! Link("$(Group):Init:CommErrorCheck:Seq.LNK1","$(Group):Init:PushCurrVal.PROC")
#! Field("$(Group):Init:CommErrorCheck:Seq.LNK2",16777215,1,"$(Group):Init:CommErrorCheck:Seq.LNK2")
#! Link("$(Group):Init:CommErrorCheck:Seq.LNK2","$(Group):Curr:InitFailed2.PROC")
#! Field("$(Group):Init:CommErrorCheck:Seq.SELL",16777215,0,"$(Group):Init:CommErrorCheck:Seq.SELL")
#! Link("$(Group):Init:CommErrorCheck:Seq.SELL","$(Group)::Init:CommCheck.VAL")
#! Record("$(Group):Init:PushCurrVal",3358,3054,0,1,"$(Group):Init:PushCurrVal")
#! Field("$(Group):Init:PushCurrVal.LNK2",16777215,1,"$(Group):Init:PushCurrVal.LNK2")
#! Link("$(Group):Init:PushCurrVal.LNK2","$(Group):InitFinished.PROC")
#! Field("$(Group):Init:PushCurrVal.LNK1",16777215,1,"$(Group):Init:PushCurrVal.LNK1")
#! Field("$(Group):Init:PushCurrVal.PROC",16777215,0,"$(Group):Init:PushCurrVal.PROC")
#! Record("$(Group):Curr:InitFailed2",3200,3422,0,1,"$(Group):Curr:InitFailed2")
#! Field("$(Group):Curr:InitFailed2.PROC",16777215,0,"$(Group):Curr:InitFailed2.PROC")
#! Field("$(Group):Curr:InitFailed2.FLNK",16777215,1,"$(Group):Curr:InitFailed2.FLNK")
#! Link("$(Group):Curr:InitFailed2.FLNK","$(Group):InitFailed:CommError")
#! Field("$(Group):Curr:InitFailed2.OUT",16777215,1,"$(Group):Curr:InitFailed2.OUT")
#! Record("$(Group):InitFailed:CommError",3500,3482,0,0,"$(Group):InitFailed:CommError")
#! Field("$(Group):InitFailed:CommError.FLNK",16777215,1,"$(Group):InitFailed:CommError.FLNK")
#! Link("$(Group):InitFailed:CommError.FLNK","$(Group):Init:CommError:True")
#! Field("$(Group):InitFailed:CommError.OUT",16777215,0,"$(Group):InitFailed:CommError.OUT")
#! Link("$(Group):InitFailed:CommError.OUT","$(Group):InitFailed:Status.VAL")
#! Record("$(Group):Init:CommError:True",3860,3422,0,0,"$(Group):Init:CommError:True")
#! Field("$(Group):Init:CommError:True.OUT",16777215,1,"$(Group):Init:CommError:True.OUT")
#! Field("$(Group):Init:CommError:True.FLNK",16777215,1,"$(Group):Init:CommError:True.FLNK")
#! Link("$(Group):Init:CommError:True.FLNK","$(Group):InitFinished")
#! Record("$(Group):InitFinished",4320,3516,0,0,"$(Group):InitFinished")
#! Field("$(Group):InitFinished.OUT",16777215,1,"$(Group):InitFinished.OUT")
#! Link("$(Group):InitFinished.OUT","$(Group):Init:Status.VAL")
#! Field("$(Group):InitFinished.PROC",16777215,0,"$(Group):InitFinished.PROC")
#! Record("$(Group):Init:Status",4700,3703,0,1,"$(Group):Init:Status")
#! Field("$(Group):Init:Status.VAL",16777215,0,"$(Group):Init:Status.VAL")
#! Record("$(Group):InitStarted",360,4322,0,1,"$(Group):InitStarted")
#! Field("$(Group):InitStarted.FLNK",16777215,0,"$(Group):InitStarted.FLNK")
#! Link("$(Group):InitStarted.FLNK","$(Group):Init:ResetInitFailed")
#! Field("$(Group):InitStarted.OUT",16777215,1,"$(Group):InitStarted.OUT")
#! Link("$(Group):InitStarted.OUT","$(Group):Init:Status.VAL")
#! Record("$(Group):InitFailed:Status",680,3763,0,1,"$(Group):InitFailed:Status")
#! Field("$(Group):InitFailed:Status.VAL",16777215,1,"$(Group):InitFailed:Status.VAL")
